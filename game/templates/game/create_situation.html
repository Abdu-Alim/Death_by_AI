{% extends 'game/base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card game-card">
                <div class="card-header bg-success text-white">
                    <h3 class="text-center mb-0"><i class="fas fa-plus-circle"></i> Создать ситуацию</h3>
                </div>
                <div class="card-body">
                    {% if error %}
                        <div class="alert alert-danger">{{ error }}</div>
                    {% endif %}
                    
                    <!-- Кнопка генерации AI -->
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-robot"></i> Сгенерировать ситуацию через ИИ</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <select class="form-select" id="ai-category">
                                        <option value="nature">Природа</option>
                                        <option value="disaster">Катастрофа</option>
                                        <option value="fantasy">Фантастика</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" id="generate-ai" class="btn btn-info w-100">
                                        <i class="fas fa-magic"></i> Сгенерировать
                                    </button>
                                </div>
                            </div>
                            <div id="ai-result" class="mt-3" style="display: none;">
                                <div class="alert alert-info">
                                    <strong>Сгенерированная ситуация:</strong>
                                    <p id="ai-situation-text" class="mb-2"></p>
                                    <button type="button" id="use-ai-situation" class="btn btn-sm btn-success">
                                        Использовать эту ситуацию
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Форма ручного создания -->
                    <form method="post" id="situation-form">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="category" class="form-label">Категория:</label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="">Выберите категорию...</option>
                                <option value="nature">Природа</option>
                                <option value="disaster">Катастрофа</option>
                                <option value="fantasy">Фантастика</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="situation_text" class="form-label">Описание ситуации:</label>
                            <textarea 
                                class="form-control" 
                                id="situation_text" 
                                name="situation_text" 
                                rows="6" 
                                placeholder="Опишите смертельно опасную ситуацию..."
                                required
                            ></textarea>
                            <div class="form-text">
                                Будьте креативны! Создайте по-настоящему сложную ситуацию для выживания.
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save"></i> Сохранить ситуацию
                            </button>
                            <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i> Назад
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generate-ai');
    const aiResult = document.getElementById('ai-result');
    const aiSituationText = document.getElementById('ai-situation-text');
    const useAiSituationBtn = document.getElementById('use-ai-situation');
    const situationTextarea = document.getElementById('situation_text');
    const categorySelect = document.getElementById('category');
    const aiCategorySelect = document.getElementById('ai-category');
    
    generateBtn.addEventListener('click', function() {
        const category = aiCategorySelect.value;
        
        // Показываем индикатор загрузки
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Генерация...';
        generateBtn.disabled = true;
        
        // Отправляем запрос на генерацию
        fetch('/generate-ai-situation/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `category=${category}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                aiSituationText.textContent = data.situation;
                aiResult.style.display = 'block';
            } else {
                alert('Ошибка генерации: ' + data.error);
            }
        })
        .catch(error => {
            alert('Ошибка сети: ' + error);
        })
        .finally(() => {
            generateBtn.innerHTML = '<i class="fas fa-magic"></i> Сгенерировать';
            generateBtn.disabled = false;
        });
    });
    
    useAiSituationBtn.addEventListener('click', function() {
        situationTextarea.value = aiSituationText.textContent;
        categorySelect.value = aiCategorySelect.value;
        aiResult.style.display = 'none';
    });
});
</script>
{% endblock %}